<!DOCTYPE html>
<html lang="az">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SchoolFlow - Final Stable</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --bg-body: #f3f4f6;
            --bg-white: #ffffff;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --info: #3b82f6;
            --sidebar-width: 260px;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-body);
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }

        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Login Screen */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }

        .login-input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: 0.3s;
        }

        .login-btn:hover {
            background: #3046c4;
        }

        /* App Layout */
        .app-container {
            display: flex;
            height: 100%;
        }

        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-white);
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .nav-item {
            padding: 12px 15px;
            margin-bottom: 5px;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            transition: 0.2s;
            color: #333;
        }

        .nav-item:hover {
            background: #f3f4f6;
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .count-badge {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .main {
            flex: 1;
            padding: 20px 40px;
            overflow-y: auto;
            position: relative;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-white);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stat-icon {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
        }

        .icon-blue {
            background: #e0e7ff;
            color: var(--primary);
        }

        .icon-red {
            background: #fee2e2;
            color: var(--danger);
        }

        .icon-yellow {
            background: #fef3c7;
            color: var(--warning);
        }

        .icon-sky {
            background: #dbeafe;
            color: var(--info);
        }

        .icon-green {
            background: #dcfce7;
            color: var(--success);
        }

        .stat-info h3 {
            margin: 0;
            font-size: 1.8rem;
        }

        .stat-info p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }

        /* Student Cards */
        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding-bottom: 80px;
        }

        .student-card {
            background: var(--bg-white);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border-top: 5px solid transparent;
            position: relative;
            transition: 0.3s;
        }

        /* Status Colors */
        .status-present {
            border-top-color: #e5e7eb;
        }

        .status-absent {
            border-top-color: var(--danger);
            background: #fff5f5;
        }

        .status-late {
            border-top-color: var(--warning);
            background: #fffbeb;
        }

        .status-permission {
            border-top-color: var(--info);
            background: #eff6ff;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .s-name {
            font-weight: 700;
            display: block;
            font-size: 1.05rem;
            cursor: pointer;
            text-decoration: underline;
            text-decoration-color: transparent;
            transition: 0.3s;
        }

        .s-name:hover {
            text-decoration-color: var(--primary);
            color: var(--primary);
        }

        .s-class {
            font-size: 0.8rem;
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 6px;
            color: #666;
        }

        .actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        /* Buttons */
        .btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            transition: 0.2s;
            font-size: 0.9rem;
        }

        .btn-absent {
            background: #ffe4e6;
            color: var(--danger);
        }

        .btn-late {
            background: #fef3c7;
            color: #d97706;
        }

        .btn-permission {
            background: #dbeafe;
            color: #1e40af;
        }

        .btn:hover {
            filter: brightness(0.95);
            transform: translateY(-1px);
        }

        .disabled-mode {
            pointer-events: none;
            opacity: 0.6;
            filter: grayscale(100%);
        }

        .search-box {
            background: var(--bg-white);
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: var(--shadow);
            width: 300px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-box input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 1rem;
        }

        .date-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        /* Notifications & Modal */
        #notification-area {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: white;
            width: 320px;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-left: 5px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideIn 0.3s forwards;
            opacity: 0;
            transform: translateX(100%);
        }

        .toast.late {
            border-left-color: var(--warning);
        }

        .toast.absent {
            border-left-color: var(--danger);
        }

        .toast.permission {
            border-left-color: var(--info);
        }

        .toast-icon {
            font-size: 1.5rem;
        }

        .toast-content h4 {
            margin: 0;
            font-size: 1rem;
            color: #333;
        }

        .toast-content p {
            margin: 5px 0 0;
            font-size: 0.85rem;
            color: #666;
        }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Modern Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
            backdrop-filter: blur(3px);
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal {
            background: white;
            width: 90%;
            max-width: 400px;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: 0.3s;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
        }

        .close-modal {
            cursor: pointer;
            color: #999;
        }

        .modal-body {
            font-size: 0.95rem;
            color: #555;
            line-height: 1.5;
        }

        .modal-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        #init-db-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            z-index: 9000;
            opacity: 0.8;
        }

        #init-db-btn:hover {
            opacity: 1;
        }
    </style>
</head>

<body>

    <div class="modal-overlay" id="customModal">
        <div class="modal">
            <div class="modal-header">
                <span id="modalTitle">BildiriÅŸ</span>
                <span class="close-modal" onclick="closeModal()">âœ•</span>
            </div>
            <div class="modal-body" id="modalContent">...</div>
        </div>
    </div>

    <div id="notification-area"></div>
    <button id="init-db-btn" onclick="seedDatabase()">ðŸ›  BazanÄ± Doldur (310 Åžagird)</button>

    <div id="login-screen">
        <div class="login-box fade-in">
            <h2 style="color:var(--primary); margin-bottom:5px;">MÉ™ktÉ™b GiriÅŸ</h2>
            <p style="color:#aaa; font-size:0.9rem; margin-bottom:20px;">Parol: <span id="passHint"></span></p>
            <input type="text" id="username" class="login-input" placeholder="User: reg / admin">
            <input type="password" id="password" class="login-input" placeholder="Parol">
            <button class="login-btn" onclick="login()">Daxil ol</button>
            <p id="loginError" style="color:red; display:none; margin-top:10px;">Parol yanlÄ±ÅŸdÄ±r!</p>
        </div>
    </div>

    <div id="app-interface" class="app-container hidden">
        <div class="sidebar">
            <h2 style="color:var(--primary); margin-bottom:30px;"><i class="fa-solid fa-graduation-cap"></i> <span
                    id="roleLabel">Panel</span></h2>
            <div id="sidebar-list"></div>
            <div style="margin-top:auto;" class="nav-item" onclick="logout()"><span><i
                        class="fa-solid fa-right-from-bracket"></i> Ã‡Ä±xÄ±ÅŸ</span></div>
        </div>

        <div class="main fade-in">
            <div class="top-bar">
                <h2 id="pageTitle">Ä°cmal</h2>

                <div id="adminTools" class="hidden">
                    <input type="date" id="historyDate" class="date-input" onchange="changeDate()">
                </div>

                <div class="search-box" id="regTools">
                    <i class="fa-solid fa-magnifying-glass" style="color:#ccc"></i>
                    <input type="text" id="searchInput" placeholder="Axtar..." onkeyup="renderStudents()">
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon icon-green"><i class="fa-solid fa-school"></i></div>
                    <div class="stat-info">
                        <h3 id="statPresent">0</h3>
                        <p>MÉ™ktÉ™bdÉ™</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon icon-red"><i class="fa-solid fa-user-xmark"></i></div>
                    <div class="stat-info">
                        <h3 id="statAbsent">0</h3>
                        <p>QayÄ±b</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon icon-yellow"><i class="fa-solid fa-clock"></i></div>
                    <div class="stat-info">
                        <h3 id="statLate">0</h3>
                        <p>GecikÉ™n</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon icon-sky"><i class="fa-solid fa-person-walking-arrow-right"></i></div>
                    <div class="stat-info">
                        <h3 id="statPermission">0</h3>
                        <p>Ä°cazÉ™li</p>
                    </div>
                </div>
                <div id="statTotal" style="display:none;">0</div>
            </div>

            <div class="student-grid" id="studentContainer">
                <p style="text-align:center; width:100%;">MÉ™lumatlar yÃ¼klÉ™nir...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, onSnapshot, writeBatch, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBQkvbGZO_CQ3DJ9IhJpcKN_wG7Emy2A28",
            authDomain: "yoxlama-50bf0.firebaseapp.com",
            projectId: "yoxlama-50bf0",
            storageBucket: "yoxlama-50bf0.firebasestorage.app",
            messagingSenderId: "853010034246",
            appId: "1:853010034246:web:e0337b03ec7b137cb3e447",
            measurementId: "G-0HQNHTJC9T"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.seedDatabase = seedDatabase;
        window.updateStudentStatus = updateStudentStatus;
        window.getStudentHistory = getStudentHistory;

        // --- 1. BAZANI DOLDURMAQ (TAM SÄ°YAHI) ---
        async function seedDatabase() {
            const allStudents = [
                { id: '1', name: 'HacÄ±zadÉ™ Hafiz Raul', class: '3A' },
                { id: '2', name: 'MÉ™rdÉ™liyev Camal Emil', class: '3A' },
                { id: '3', name: 'Æliyev Atilla ElÃ§in', class: '3A' },
                { id: '4', name: 'Cavadova XanÄ±m RÃ¼fÉ™t', class: '3A' },
                { id: '5', name: 'Ælisoy Banu Anar', class: '3A' },
                { id: '6', name: 'HÃ¼seynova ÆminÉ™ Samir', class: '3A' },
                { id: '7', name: 'MiÅŸeli Ali Efe Remzi', class: '3A' },
                { id: '8', name: 'SÉ™fÉ™rli ZeynÉ™b ÅžÃ¶vqi', class: '3A' },
                { id: '9', name: 'XÉ™lil DÉ™fnÉ™ Firdovsi', class: '3A' },
                { id: '10', name: 'KaraÅŸahin Emir YiÄŸit Ramazan', class: '3A' },
                { id: '11', name: 'Ä°slamov Ariz Orxan', class: '3A' },
                { id: '12', name: 'MÉ™hÉ™rrÉ™mli Mehri Ä°lqar', class: '3A' },
                { id: '13', name: 'Zakirova MÉ™ryÉ™m MÉ™tlÉ™b', class: '3A' },
                { id: '14', name: 'NÉ™isibli SÉ™ma ElÅŸÉ™n', class: 'Pre-School (Nigina)' },
                { id: '15', name: 'SÃ¼leymanlÄ± Ã–mÉ™r Cabir', class: 'Pre-School (Nigina)' },
                { id: '16', name: 'HÃ¼seyn Abdullah Nazim', class: 'Pre-School (Nigina)' },
                { id: '17', name: 'ÆlÉ™kbÉ™rova Mehri ElÅŸad', class: 'Pre-School (Nigina)' },
                { id: '18', name: 'HÉ™sÉ™nli Yunus Ä°mdad', class: 'Pre-School (Nigina)' },
                { id: '19', name: 'Mehdiyev GÉ™ray AydÄ±n', class: 'Pre-School (Nigina)' },
                { id: '20', name: 'HÃ¼seynli Humay Araz', class: 'Pre-School (Nigina)' },
                { id: '21', name: 'XÉ™lilli Cansu VÃ¼qar', class: 'Pre-School (Nigina)' },
                { id: '22', name: 'ÆhmÉ™dli Turqut Fazil', class: 'Pre-School (Nigina)' },
                { id: '23', name: 'SÉ™fÉ™rli FÉ™rÉ™h Elnur', class: 'Pre-School (Nigina)' },
                { id: '24', name: 'BÉ™ylÉ™rova Ayan Mahir qÄ±zÄ±', class: 'Pre-School (Nigina)' },
                { id: '25', name: 'VÉ™lizadÉ™ DoÄŸan Aqil', class: '2B' },
                { id: '26', name: 'KÉ™rimova NÉ™rgiz Cavid', class: '2B' },
                { id: '27', name: 'KÉ™rimov Æziz Cavid', class: '2B' },
                { id: '28', name: 'VÉ™liyev Raul Ramin', class: '2B' },
                { id: '29', name: 'RÉ™sulova Nilay Fuad', class: '2B' },
                { id: '30', name: 'Æliyeva MÉ™dinÉ™ Vahid', class: '2B' },
                { id: '31', name: 'Piriyeva Aylin Zaur', class: '2B' },
                { id: '32', name: 'ÆkbÉ™r AliyÉ™ ElÃ§in', class: '2B' },
                { id: '33', name: 'HacÄ±yeva MÉ™dinÉ™ Samir', class: '2B' },
                { id: '34', name: 'SÃ¼leymanova Melissa Ruslan', class: '2B' },
                { id: '35', name: 'QasÄ±mov Davud Rafiq', class: '2B' },
                { id: '36', name: 'NÉ™isibli Saleh ElÅŸÉ™n', class: '2B' },
                { id: '37', name: 'Ä°salÄ± HÃ¼seyn Elnur', class: '2B' },
                { id: '38', name: 'Kamilli BadisÉ™ba CÉ™mil', class: '2B' },
                { id: '39', name: 'AÄŸayeva Elyanora Elnur', class: '2B' },
                { id: '40', name: 'ÆsÉ™dova Humay Ruslan', class: '2B' },
                { id: '41', name: 'FÉ™tiyev Ceylan VÃ¼qar', class: '2B' },
                { id: '42', name: 'Safiya ÆhmÉ™dzadÉ™ Camal', class: 'Pre-School (Aysu)' },
                { id: '43', name: 'KazÄ±mova Sofiya ÆhÉ™d', class: 'Pre-School (Aysu)' },
                { id: '44', name: 'Namazov Cavidan Anar', class: 'Pre-School (Aysu)' },
                { id: '45', name: 'MÉ™hÉ™rrÉ™mli Altay Ä°lqar', class: 'Pre-School (Aysu)' },
                { id: '46', name: 'Quliyeva ÅžÉ™ms Orxan', class: 'Pre-School (Aysu)' },
                { id: '47', name: 'Æliyeva GÃ¼lxÉ™ndÉ™ Ziya', class: 'Pre-School (Aysu)' },
                { id: '48', name: 'ÆhmÉ™dli Selin Tural', class: 'Pre-School (Aysu)' },
                { id: '49', name: 'Miriyev Mircabbar RÃ¼fÉ™t', class: 'Pre-School (Aysu)' },
                { id: '50', name: 'Æmirli ÆsmÉ™r SaxavÉ™ddin qÄ±zÄ±', class: 'Pre-School (Aysu)' },
                { id: '51', name: 'SultanlÄ± Mirsahib Mirdavud oÄŸlu', class: 'Pre-School (Aysu)' },
                { id: '52', name: 'Mansirov CÉ™lal Nizami', class: '4A' },
                { id: '53', name: 'MÉ™mmÉ™dov HÃ¼seyn Anar', class: '4A' },
                { id: '54', name: 'Eyvazov Cavad XÉ™yyam', class: '4A' },
                { id: '55', name: 'Ä°brahimli Camal Kamran', class: '4A' },
                { id: '56', name: 'Mustafa AyÅŸÉ™nur RÉ™him', class: '4A' },
                { id: '57', name: 'Æliyev Tamerlan HikmÉ™t', class: '4A' },
                { id: '58', name: 'HeydÉ™rov MÉ™hÉ™mmÉ™d SÃ¼leyman', class: '4A' },
                { id: '59', name: 'MÉ™mmÉ™dli Banu Emil', class: '4A' },
                { id: '60', name: 'HÃ¼mmÉ™tova ÆsmÉ™r Emil', class: '4A' },
                { id: '61', name: 'HÃ¼mmÉ™tov Ayaz Emil', class: '4A' },
                { id: '62', name: 'SÉ™mÉ™dli Miray Alim', class: '4A' },
                { id: '63', name: 'QasÄ±mlÄ± DÉ™niz Soltan', class: '4A' },
                { id: '64', name: 'Cavadova Sara RÃ¼fÉ™t', class: '4A' },
                { id: '65', name: 'MÉ™rdanlÄ± MÉ™lÉ™k Æli', class: '4A' },
                { id: '66', name: 'HÃ¼seynli Kamil ÆhmÉ™d', class: '4A' },
                { id: '67', name: 'AdÄ±gÃ¶zÉ™lova NilufÉ™r Orxan', class: '4A' },
                { id: '68', name: 'ÆsgÉ™r AiÅŸÉ™ MÉ™tlÉ™b', class: '4A' },
                { id: '69', name: 'ÅžÃ¼kÃ¼rlÃ¼ DilÉ™k Anar', class: '4A' },
                { id: '70', name: 'HÉ™midsoy Ä°nci SÉ™buhi', class: '4A' },
                { id: '71', name: 'Ã–mrÃ¼mova Arzu Nicat', class: '4A' },
                { id: '72', name: 'FÉ™rhadov Fuad MirzÉ™', class: '2A' },
                { id: '73', name: 'HÉ™sÉ™nli Ä°nci Azad', class: '2A' },
                { id: '74', name: 'BabaoÄŸlu Muhammed Kerem', class: '2A' },
                { id: '75', name: 'AbaslÄ± MÉ™ryÉ™m Orxan', class: '2A' },
                { id: '76', name: 'GÃ¶yÃ¼ÅŸlÃ¼ MÉ™lÉ™k AzÉ™r', class: '2A' },
                { id: '77', name: 'AÄŸayeva ZeynÉ™b ElÅŸÉ™n', class: '2A' },
                { id: '78', name: 'AÄŸayeva MÉ™ryÉ™m ElÅŸÉ™n', class: '2A' },
                { id: '79', name: 'Ä°brahimli Cahan Kamran', class: '2A' },
                { id: '80', name: 'Rzayeva FatimÉ™ Tural', class: '2A' },
                { id: '81', name: 'Babaev Ä°lkin NiyamÉ™ddin', class: '2A' },
                { id: '82', name: 'MÉ™mmÉ™dli Cavad Nicat', class: '2A' },
                { id: '83', name: 'MustafazadÉ™ Mirteymur Mircavad', class: '2A' },
                { id: '84', name: 'GÃ¶zÉ™lov Alparslan Tural', class: '2A' },
                { id: '85', name: 'HÃ¼mbÉ™tzadÉ™ Sofiya Rauf', class: '2A' },
                { id: '86', name: 'Roman Qurbanov Teymur', class: '2A' },
                { id: '87', name: 'ÆlizadÉ™ Ceyhan FÃ¼zuli', class: '2A' },
                { id: '88', name: 'Zakirov MÉ™rdan MÉ™tlÉ™b', class: '2A' },
                { id: '89', name: 'KanberoÄŸlu Melis Ã–nder', class: '2A' },
                { id: '90', name: 'HÉ™sÉ™nli SÉ™lim Orxan', class: '2A' },
                { id: '91', name: 'ÆlÉ™kbÉ™rova Sevil ElÅŸad', class: '1A' },
                { id: '92', name: 'ÆlÉ™kbÉ™rli Altun Kamran', class: '1A' },
                { id: '93', name: 'Ä°brahimli Mirel Faiq', class: '1A' },
                { id: '94', name: 'Piriyev David Zaur', class: '1A' },
                { id: '95', name: 'Ä°brahimli Suad SÉ™rxan', class: '1A' },
                { id: '96', name: 'ÆhmÉ™d Ä°brahim Æli', class: '1A' },
                { id: '97', name: 'Eminli SÉ™mra ElÅŸad', class: '1A' },
                { id: '98', name: 'Ä°brahimova Leyla ElÅŸad', class: '1A' },
                { id: '99', name: 'Abbas NÉ™rgiz ElÃ§in', class: '1A' },
                { id: '100', name: 'Ælisoy Sara Ramal', class: '1A' },
                { id: '101', name: 'EyvazlÄ± Turqut TÉ™mkin', class: '1A' },
                { id: '102', name: 'Æmirli Ä°radÉ™ SaxavÉ™ddin', class: '1A' },
                { id: '103', name: 'VÉ™liyeva Aylin ElÅŸad', class: '1A' },
                { id: '104', name: 'RÉ™fizadÉ™ Humay Ä°brahim', class: '1A' },
                { id: '105', name: 'QasÄ±mlÄ± Hiranur VÉ™li', class: '1A' },
                { id: '106', name: 'Æzimov Maqsud Nicat', class: '1A' },
                { id: '107', name: 'CÉ™fÉ™r ÅžÃ¶vqi AzÉ™r', class: '1A' },
                { id: '108', name: 'HÉ™midsoy Sevil SÉ™buhi', class: '1A' },
                { id: '109', name: 'AbbaszadÉ™ MÉ™ryÉ™m Murad', class: '1A' },
                { id: '110', name: 'ÆhmÉ™dli Ä°brahim Fazil', class: '1A' },
                { id: '111', name: 'Abdullah Ä°rfan Ziya', class: '3B' },
                { id: '112', name: 'MÉ™rdÉ™liyeva Aylin Emil', class: '3B' },
                { id: '113', name: 'Yener Amine Sercan', class: '3B' },
                { id: '114', name: 'Quliyeva Melis Æziz', class: '3B' },
                { id: '115', name: 'TaÄŸÄ±zadÉ™ MÉ™lÉ™k Elzamin', class: '3B' },
                { id: '116', name: 'YÄ±ldÄ±rÄ±m ErtuÄŸrul ZÃ¼lkÃ¼f', class: '3B' },
                { id: '117', name: 'Ravza AltÄ±ntop', class: '3B' },
                { id: '118', name: 'MÉ™mmÉ™dova Nigar MÃ¼ÅŸfiq', class: '3B' },
                { id: '119', name: 'HeydÉ™rli HeydÉ™r Savalan', class: '3B' },
                { id: '120', name: 'AdÄ±gÃ¶zÉ™lov MÉ™hÉ™mmÉ™dÉ™li RÃ¶vÅŸÉ™n', class: '3B' },
                { id: '121', name: 'AbbaslÄ± Ä°nci Abbas', class: '3B' },
                { id: '122', name: 'MusalÄ± FÉ™rÉ™h PÉ™rviz qÄ±zÄ±', class: '3B' },
                { id: '123', name: 'Aliyev Maisa', class: '3B' },
                { id: '124', name: 'AÄŸazadÉ™ UÄŸur Elnur', class: 'Pre-School (Aydan)' },
                { id: '125', name: 'Æliyeva AyÉ™t HikmÉ™t', class: 'Pre-School (Aydan)' },
                { id: '126', name: 'ÆblÉ™sÉ™nova Cahan RÉ™ÅŸad', class: 'Pre-School (Aydan)' },
                { id: '127', name: 'Ä°slamzadÉ™ Turqut Namiq', class: 'Pre-School (Aydan)' },
                { id: '128', name: 'ZÃ¼lfÃ¼qarlÄ± Sevinc Asim', class: 'Pre-School (Aydan)' },
                { id: '129', name: 'AÄŸabÉ™yzadÉ™ Faiq RÉ™cÉ™b', class: 'Pre-School (Aydan)' },
                { id: '130', name: 'Ä°badzadÉ™ Miryusif Elmir', class: 'Pre-School (Aydan)' },
                { id: '131', name: 'MÉ™hÉ™rrÉ™mzadÉ™ Araz Anar', class: 'Pre-School (Aydan)' },
                { id: '132', name: 'ÆsgÉ™rli Tuana Nicat', class: 'Pre-School (Aydan)' },
                { id: '133', name: 'Ä°manlÄ± Melisa RuhÉ™li', class: 'Pre-School (Aydan)' },
                { id: '134', name: 'HÃ¼seynzadÉ™ Sara Cahangir', class: 'Pre-School (Aydan)' },
                { id: '135', name: 'HÉ™sÉ™nli Ayla Azad', class: '1B' },
                { id: '136', name: 'BaÄŸÄ±rzadÉ™ Selcan ElÅŸÉ™n', class: '1B' },
                { id: '137', name: 'MÉ™mmÉ™dli Turan Emil', class: '1B' },
                { id: '138', name: 'PaÅŸayev Yusif Zaur', class: '1B' },
                { id: '139', name: 'Ä°brahimova Sara ElÅŸad', class: '1B' },
                { id: '140', name: 'AÅŸurov Mahir SÉ™nan', class: '1B' },
                { id: '141', name: 'BÉ™ylÉ™r FÉ™rhad Anar', class: '1B' },
                { id: '142', name: 'AÄŸalÄ± Mira XeyrÉ™ddin', class: '1B' },
                { id: '143', name: 'GÃ¶zÉ™lova Sunay Tural', class: '1B' },
                { id: '144', name: 'HacÄ±yev Ä°lqar Aqil', class: '1B' },
                { id: '145', name: 'KazÄ±mova TahirÉ™ ÆhÉ™d', class: '1B' },
                { id: '146', name: 'RÃ¼stÉ™m Nur Ãœlvi', class: '1B' },
                { id: '147', name: 'Allahverdiyeva Milana FÉ™rid', class: '1B' },
                { id: '148', name: 'AdÄ±gÃ¶zÉ™lov Elmar Orxan', class: '1B' },
                { id: '149', name: 'Sadmaliyeva Ayza Zahid', class: '1B' },
                { id: '150', name: 'Ã‡aÄŸlayan Asya Lina', class: '1B' },
                { id: '151', name: 'HÃ¼seynzadÉ™ Jasmin Cahangir', class: '1B' },
                { id: '152', name: 'AbbaslÄ± ÆlÉ™kbÉ™r Abbas', class: '1B' },
                { id: '153', name: 'QulizadÉ™ FikrÉ™t Samir', class: '1B' },
                { id: '154', name: 'TaÄŸÄ±zadÉ™ FatimÉ™ Elzamin', class: '6B' },
                { id: '155', name: 'GÃ¶zÉ™lova AidÉ™ Tural', class: '6B' },
                { id: '156', name: 'FÉ™rzÉ™liyev FÉ™rid Samir', class: '6B' },
                { id: '157', name: 'Ã–mrÃ¼mov Murat Nicat', class: '6B' },
                { id: '158', name: 'RÉ™sulova Aida VÃ¼qar', class: '6B' },
                { id: '159', name: 'NÉ™isibli MÉ™sim RÃ¼stÉ™m', class: '6B' },
                { id: '160', name: 'HÃ¼seynli MÉ™ryÉ™m Araz', class: '6B' },
                { id: '161', name: 'AbaslÄ± MÉ™hÉ™mmÉ™d Xalid', class: '6B' },
                { id: '162', name: 'HÉ™sÉ™nov Ã–mÉ™r Orxan', class: '6B' },
                { id: '163', name: 'ÆkbÉ™rli Fidan NÉ™riman', class: '6B' },
                { id: '164', name: 'Nadirova MÉ™dinÉ™ RÉ™ÅŸad', class: '6B' },
                { id: '165', name: 'GÃ¼lverdiyeva DÉ™niz QoÅŸqar', class: '6B' },
                { id: '166', name: 'ÅžahbazzadÉ™ Banu Ziya', class: '6B' },
                { id: '167', name: 'Piriyev Abdullah Sunay oÄŸlu', class: '6B' },
                { id: '168', name: 'Aliyev Abbas Kaan', class: '6B' },
                { id: '169', name: 'Æliyeva Aydan Zamiq qÄ±zÄ±', class: '6B' },
                { id: '170', name: 'Abdulhamit Kara', class: '6B' },
                { id: '171', name: 'SultanÉ™hmÉ™dov Rafiq Ramin', class: '7B' },
                { id: '172', name: 'BaÄŸÄ±rov Æliyar Emin', class: '7B' },
                { id: '173', name: 'MÉ™mmÉ™dli HÃ¼seyn VÃ¼qar', class: '7B' },
                { id: '174', name: 'OÄŸuzxan Qurbanov Teymur', class: '7B' },
                { id: '175', name: 'MuradzadÉ™ KÉ™nan RÃ¶vÅŸÉ™n', class: '7B' },
                { id: '176', name: 'MuradzadÉ™ Nadir RÃ¶vÅŸÉ™n', class: '7B' },
                { id: '177', name: 'Åžahmarova Milana Ä°srafil', class: '7B' },
                { id: '178', name: 'MÉ™mmÉ™dli Davud RÃ¶vÅŸÉ™n', class: '7B' },
                { id: '179', name: 'MusalÄ± Fateh PÉ™rviz oÄŸlu', class: '7B' },
                { id: '180', name: 'Ä°brahimov MÉ™mmÉ™daÄŸa VeysÉ™l oÄŸlu', class: '7B' },
                { id: '181', name: 'SÉ™fÉ™rÉ™liyeva ZÉ™rif Ä°ntiqam qÄ±zÄ±', class: '7B' },
                { id: '182', name: 'MÉ™mmÉ™dli DÉ™niz VÃ¼sal', class: '7B' },
                { id: '183', name: 'HÃ¼seynli FatimÉ™ Araz', class: '8' },
                { id: '184', name: 'KÉ™rimli Nuran Ramil', class: '8' },
                { id: '185', name: 'ZÃ¼lfÃ¼qarlÄ± Resul ElÃ§in', class: '8' },
                { id: '186', name: 'ÆhmÉ™dov Ã–mÉ™r Rahim', class: '8' },
                { id: '187', name: 'Eminova CÉ™vahir NÉ™zÉ™r', class: '8' },
                { id: '188', name: 'HÃ¼seynov AÄŸarza Samir', class: '8' },
                { id: '189', name: 'MÃ¼slÃ¼m MÉ™hÉ™mmÉ™d Emin Yusif', class: '8' },
                { id: '190', name: 'HÃ¼seynli Nihat Emin', class: '8' },
                { id: '191', name: 'FÉ™rzÉ™liyev Camal Samir', class: '8' },
                { id: '192', name: 'AÄŸakiÅŸiyev HÃ¼seyn ÆlÉ™kbÉ™r', class: '8' },
                { id: '193', name: 'MuradzadÉ™ Nuran Nurlan', class: '8' },
                { id: '194', name: 'Ä°slamzadÉ™ Æli Namiq', class: '8' },
                { id: '195', name: 'MÉ™simli Ä°smayÄ±l CoÅŸqun', class: '8' },
                { id: '196', name: 'Æliyev Novruz Nicat', class: '8' },
                { id: '197', name: 'ÆsÉ™dov Nail Ruslan', class: '8' },
                { id: '198', name: 'ÆsgÉ™rova TÃ¼rkan Nail', class: '8' },
                { id: '199', name: 'Ä°skÉ™ndÉ™rli Sevil Anar', class: '8' },
                { id: '200', name: 'Ä°manlÄ± GÃ¼lzar Ãœlvi qÄ±zÄ±', class: '8' },
                { id: '201', name: 'Æliyev Ramal Zamiq oÄŸlu', class: '8' },
                { id: '202', name: 'MÉ™likov Ä°mran ElÃ§in', class: '7A' },
                { id: '203', name: 'Abdullah Ramiz Ziya', class: '7A' },
                { id: '204', name: 'Abbasov Attila ZÉ™ka', class: '7A' },
                { id: '205', name: 'MÃ¼slÃ¼m Æli Yusif', class: '7A' },
                { id: '206', name: 'ÆsgÉ™rzadÉ™ SÉ™mÉ™d YalÃ§Ä±n', class: '7A' },
                { id: '207', name: 'Ä°salÄ± ZeynÉ™b Elnur', class: '7A' },
                { id: '208', name: 'Bayramov MÉ™hÉ™mmÉ™dcavad Cavid', class: '7A' },
                { id: '209', name: 'HÉ™sÉ™n Amir Vaqif', class: '7A' },
                { id: '210', name: 'Emir KaÄŸan AltÄ±ntop', class: '7A' },
                { id: '211', name: 'QÃ¼drÉ™tzadÉ™ ZÉ™rif Elnur', class: '7A' },
                { id: '212', name: 'RÉ™sulov Ä°slam VÃ¼qar', class: '7A' },
                { id: '213', name: 'MuradzadÉ™ NazlÄ± Nurlan', class: '7A' },
                { id: '214', name: 'QÉ™hrÉ™manbÉ™yli FÉ™rman Samir', class: '9' },
                { id: '215', name: 'Cahangirov FÉ™rid Asif', class: '9' },
                { id: '216', name: 'SÃ¼leymanova Ä°nci Ruslan', class: '9' },
                { id: '217', name: 'QasÄ±mlÄ± NailÉ™ Soltan', class: '9' },
                { id: '218', name: 'Bayramova YasÉ™mÉ™n Cavid', class: '9' },
                { id: '219', name: 'YÄ±lmaz Yasin Cuma', class: '9' },
                { id: '220', name: 'QaraÅŸzadÉ™ CÉ™lal Ä°brahim', class: '9' },
                { id: '221', name: 'Qafur QÃ¼drÉ™tzadÉ™ Elnur', class: '9' },
                { id: '222', name: 'ZÃ¼lfÃ¼qarlÄ± ZÃ¼lfiyyÉ™ Asim', class: '9' },
                { id: '223', name: 'SÉ™fÉ™rova Ayan Rafael', class: '9' },
                { id: '224', name: 'RÃ¼stÉ™mzadÉ™ GÃ¼lsÃ¼m', class: '9' },
                { id: '225', name: 'ÆsÉ™dov RÉ™sul Ruslan', class: '9' },
                { id: '226', name: 'BaÄŸÄ±rova Jasmin FÉ™rid', class: '9' },
                { id: '227', name: 'Mikailli Ã–mÉ™r Ruslan oÄŸlu', class: '9' },
                { id: '228', name: 'SÉ™fÉ™rÉ™liyeva Humay Ä°ntiqam', class: '9' },
                { id: '229', name: 'SultanlÄ± Leyla Mirdavud qÄ±zÄ±', class: '9' },
                { id: '230', name: 'Ã–zdemir Ahmet Selim UÄŸur', class: '9' },
                { id: '231', name: 'Eraslan Ã–ykÃ¼ Cafer', class: '9' },
                { id: '232', name: 'Ahmet Kayra GÃ¼lbay', class: '9' },
                { id: '233', name: 'GÃ¼mÃ¼ÅŸ Tusem Muhammet', class: '9' },
                { id: '234', name: 'HÃ¼seynli ZeynÉ™b Araz', class: '6A' },
                { id: '235', name: 'Cahangirova Leyla Asif', class: '6A' },
                { id: '236', name: 'MÉ™mmÉ™dli Ã–mÉ™r Emil', class: '6A' },
                { id: '237', name: 'Ä°smayÄ±lzadÉ™ Davud RÉ™hman', class: '6A' },
                { id: '238', name: 'MÉ™mmÉ™dov Talib XÉ™qani', class: '6A' },
                { id: '239', name: 'AbdullazadÉ™ Yusif Ruslan', class: '6A' },
                { id: '240', name: 'Selin Esra KoÃ§ Nuh', class: '6A' },
                { id: '241', name: 'BabakiÅŸiyeva AyiÅŸÉ™ BÉ™hman', class: '6A' },
                { id: '242', name: 'VÉ™lizadÉ™ Nilay Anar', class: '6A' },
                { id: '243', name: 'Abbas SafiyÉ™ ElÃ§in', class: '6A' },
                { id: '244', name: 'Yener Ahmet Bilal Sercan', class: '6A' },
                { id: '245', name: 'Allahverdi Yusif Ramil', class: '6A' },
                { id: '246', name: 'XÉ™lil DÉ™niz Firdovsi', class: '6A' },
                { id: '247', name: 'Ä°salÄ± Ayla HÉ™sÉ™n', class: '6A' },
                { id: '248', name: 'BeyazÄ±t Alkan Samet', class: '6A' },
                { id: '249', name: 'Ä°manlÄ± FatimÉ™ RuhÉ™li', class: '6A' },
                { id: '250', name: 'MÉ™mmÉ™dli OÄŸuz VÃ¼sal', class: '6A' },
                { id: '251', name: 'AydoÄŸmuÅŸ Elif Yaren', class: '6A' },
                { id: '252', name: 'MÉ™mmÉ™dov Murad MÃ¼ÅŸfiq', class: '5B' },
                { id: '253', name: 'GÃ¼lafzadÉ™ FÉ™rÉ™h Fuad', class: '5B' },
                { id: '254', name: 'AlÅŸanlÄ± Aytac RÉ™ÅŸad', class: '5B' },
                { id: '255', name: 'Sadullayeva Amira Elxan', class: '5B' },
                { id: '256', name: 'Åžahmarova Sofiya Ä°srafil', class: '5B' },
                { id: '257', name: 'Ã‡Ä±raqzadÉ™ Esmanur Nazir', class: '5B' },
                { id: '258', name: 'NÉ™isibli FÉ™rhad Tural', class: '5B' },
                { id: '259', name: 'Demir HÃ¼lya Miray Ä°brahim', class: '5B' },
                { id: '260', name: 'Æliyev Raul RÉ™ÅŸid', class: '5B' },
                { id: '261', name: 'Fleq FÉ™hrin Yusif', class: '5B' },
                { id: '262', name: 'ÅžÉ™fizadÉ™ Ä°smayÄ±l Elvin', class: '5B' },
                { id: '263', name: 'KazÄ±mlÄ± Altay Araz', class: '5B' },
                { id: '264', name: 'RÉ™fiyev Ä°smayÄ±l Polad', class: '5B' },
                { id: '265', name: 'HÃ¼seynli Fidan Araz', class: '5B' },
                { id: '266', name: 'Yaqublu Yusif Oqtay', class: '5B' },
                { id: '267', name: 'Æliyev Ã–mÉ™r Nicat', class: '5B' },
                { id: '268', name: 'ÆbdÃ¼lÉ™zim OÄŸuz Ä°smayÄ±l', class: '5B' },
                { id: '269', name: 'ÆbdÃ¼lÉ™zim ÆminÉ™ Ä°smayÄ±l', class: '5B' },
                { id: '270', name: 'BaÄŸÄ±rov Mircamal FÉ™rid', class: '5B' },
                { id: '271', name: 'HeydÉ™rov Ziya Æzim oÄŸlu', class: '5B' },
                { id: '272', name: 'Mikailli NazlÄ± Ruslan qÄ±zÄ±', class: '5B' },
                { id: '273', name: 'Feyzullayeva Cansu Etibar', class: '5A' },
                { id: '274', name: 'Ä°brahimli Leyla Faiq', class: '5A' },
                { id: '275', name: 'Cahangirov Amir Asif', class: '5A' },
                { id: '276', name: 'KÉ™rimli Ä°brahim Ramil', class: '5A' },
                { id: '277', name: 'YÃ¼zbaÅŸova Leyli RÃ¼fÉ™t', class: '5A' },
                { id: '278', name: 'SÃ¼leymanlÄ± Yusuf Cabir', class: '5A' },
                { id: '279', name: 'MÉ™mmÉ™dli Murad Nicat', class: '5A' },
                { id: '280', name: 'ÆlizadÉ™ Ayxan Anar', class: '5A' },
                { id: '281', name: 'HÃ¼seynzadÉ™ SÉ™mÉ™d Murad', class: '5A' },
                { id: '282', name: 'Namazova Fidan Anar', class: '5A' },
                { id: '283', name: 'QasÄ±mova Ä°nci Tale', class: '5A' },
                { id: '284', name: 'HÉ™sÉ™n AsÉ™f Vaqif', class: '5A' },
                { id: '285', name: 'QaraÅŸov Kamal Ä°brahim', class: '5A' },
                { id: '286', name: 'ZÉ™fÉ™r QÃ¼drÉ™tzadÉ™ Elnur', class: '5A' },
                { id: '287', name: 'RÃ¼stÉ™mzadÉ™ FÉ™rid ElÅŸÉ™n', class: '5A' },
                { id: '288', name: 'ÆlizadÉ™ LalÉ™ PÉ™rviz', class: '5A' },
                { id: '289', name: 'XanmÉ™mmÉ™dov ÆsmÉ™r RÉ™ÅŸad', class: '5A' },
                { id: '290', name: 'XanmÉ™mmÉ™dov Murad RÉ™ÅŸad', class: '5A' },
                { id: '291', name: 'Ä°sgÉ™ndÉ™rli ZeynÉ™b SÉ™rxan', class: '5A' },
                { id: '292', name: 'SÉ™rxanlÄ± SÉ™rxan XÉ™qani', class: '5A' },
                { id: '293', name: 'Ã–zdemir Sena UÄŸur qÄ±zÄ±', class: '5A' },
                { id: '294', name: 'AdÄ±gÃ¶zÉ™lov Cavad Orxan', class: '4B' },
                { id: '295', name: 'Alina ÆbÃ¼lhÉ™sÉ™nli TÃ¼rkel', class: '4B' },
                { id: '296', name: 'MÉ™rdan OÄŸuzxan Orxan', class: '4B' },
                { id: '297', name: 'Ã‡Ä±raqzadÉ™ ÆrtuÄŸrul Nazir', class: '4B' },
                { id: '298', name: 'Demir Aras Ä°brahim', class: '4B' },
                { id: '299', name: 'ÆsgÉ™r Osman SÉ™nan', class: '4B' },
                { id: '300', name: 'AbaslÄ± Ä°mran Xalid', class: '4B' },
                { id: '301', name: 'ÆsgÉ™rsoy NazlÄ± Ä°smayÄ±l', class: '4B' },
                { id: '302', name: 'ÆhmÉ™dli MikayÄ±l Tural', class: '4B' },
                { id: '303', name: 'ÆsgÉ™rov Yasin Nail', class: '4B' },
                { id: '304', name: 'ÆlÉ™kbÉ™rli Turxan ToÄŸrul', class: '4B' },
                { id: '305', name: 'GÃ¼lverdiyev Ayxan QoÅŸqar', class: '4B' },
                { id: '306', name: 'BaxÅŸÉ™lizadÉ™ Atilla XÉ™zri', class: '4B' },
                { id: '307', name: 'ÆkbÉ™rzadÉ™ SÉ™lim RÉ™ÅŸad oÄŸlu', class: '4B' },
                { id: '308', name: 'SÉ™fÉ™rÉ™liyev BÉ™hman Ä°ntiqam oÄŸlu', class: '4B' },
                { id: '309', name: 'SultanlÄ± Banu Mirdavud qÄ±zÄ±', class: '4B' },
                { id: '310', name: 'MÉ™mmÉ™dov SÉ™id PÉ™rviz oÄŸlu', class: '4B' }
            ];

            if (!confirm("DiqqÉ™t! BÃ¼tÃ¼n mÉ™lumatlar silinib " + allStudents.length + " ÅŸagird yazÄ±lacaq. RazÄ±san?")) return;

            const batch = writeBatch(db);

            allStudents.forEach(student => {
                const docRef = doc(db, "students", student.id);
                batch.set(docRef, { ...student, status: 'present', time: '', lastUpdated: new Date().toISOString() });
            });

            await batch.commit();
            customAlert("Baza uÄŸurla dolduruldu! SÉ™hifÉ™ yenilÉ™nir.");
            setTimeout(() => location.reload(), 1500);
        }

        // --- 2. STATUS YENÄ°LÆMÆK (Log ilÉ™) ---
        async function updateStudentStatus(id, type) {
            if (window.userRole === 'admin') return;

            const todayDate = new Date().toISOString().split('T')[0];
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');

            const currentS = window.currentData.find(s => s.id === id);

            let finalStatus = type;
            let finalTime = (type === 'late' || type === 'permission') ? timeStr : '';

            if (currentS && currentS.status === type) {
                finalStatus = 'present';
                finalTime = '';
            }

            // Update Master
            const studentRef = doc(db, "students", id);
            await updateDoc(studentRef, {
                status: finalStatus,
                time: finalTime
            });

            // Update Log
            const logId = `${todayDate}_${id}`;
            const logRef = doc(db, "attendance", logId);

            await setDoc(logRef, {
                studentId: id,
                name: currentS.name,
                class: currentS.class,
                date: todayDate,
                status: finalStatus,
                time: finalTime
            });
        }

        // --- 3. ÅžAGÄ°RD DOSYESÄ° ---
        async function getStudentHistory(id) {
            const q = query(collection(db, "attendance"), where("studentId", "==", id));
            const querySnapshot = await getDocs(q);

            let late = 0, absent = 0, perm = 0;

            querySnapshot.forEach((doc) => {
                const d = doc.data();
                if (d.status === 'late') late++;
                if (d.status === 'absent') absent++;
                if (d.status === 'permission') perm++;
            });

            const student = window.currentData.find(s => s.id === id);

            const html = `
                <div class="modal-row"><span>Ad Soyad:</span> <strong>${student.name}</strong></div>
                <div class="modal-row"><span>Sinif:</span> <strong>${student.class}</strong></div>
                <hr style="margin:10px 0; border:0; border-top:1px solid #eee;">
                <div class="modal-row"><span>QayÄ±b:</span> <strong style="color:var(--danger)">${absent}</strong></div>
                <div class="modal-row"><span>GecikmÉ™:</span> <strong style="color:var(--warning)">${late}</strong></div>
                <div class="modal-row"><span>Ä°cazÉ™:</span> <strong style="color:var(--info)">${perm}</strong></div>
            `;

            customAlert(html, "Åžagird Dosyesi");
        }

        // --- 4. REALTIME LISTENER & HISTORY ---
        window.startRealtimeListener = function () {
            const today = new Date().toISOString().split('T')[0];
            if (window.userRole === 'admin') {
                document.getElementById('historyDate').value = today;
            }
            window.currentDateFilter = today;
            loadData();
        }

        window.loadData = function () {
            const today = new Date().toISOString().split('T')[0];
            const selectedDate = window.currentDateFilter;

            if (selectedDate === today) {
                const q = collection(db, "students");
                window.unsubscribe = onSnapshot(q, (snapshot) => {
                    const students = [];
                    snapshot.forEach((doc) => { students.push(doc.data()); });
                    window.currentData = students;
                    renderAppUI();

                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "modified" && window.userRole === 'admin') {
                            const data = change.doc.data();
                            if (data.status !== 'present') showNotification(data.name, data.status, data.class);
                        }
                    });
                });
            } else {
                if (window.unsubscribe) window.unsubscribe();

                getDocs(collection(db, "students")).then(masterSnap => {
                    let tempStudents = [];
                    masterSnap.forEach(doc => {
                        tempStudents.push({ ...doc.data(), status: 'present', time: '' });
                    });

                    const qLog = query(collection(db, "attendance"), where("date", "==", selectedDate));
                    getDocs(qLog).then(logSnap => {
                        logSnap.forEach(doc => {
                            const log = doc.data();
                            const index = tempStudents.findIndex(s => s.id === log.studentId);
                            if (index !== -1) {
                                tempStudents[index].status = log.status;
                                tempStudents[index].time = log.time;
                            }
                        });
                        window.currentData = tempStudents;
                        renderAppUI();
                    });
                });
            }
        }

        window.changeDate = function () {
            window.currentDateFilter = document.getElementById('historyDate').value;
            loadData();
        }

        window.customAlert = function (content, title = "BildiriÅŸ") {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('customModal').classList.add('active');
        }
        window.closeModal = function () {
            document.getElementById('customModal').classList.remove('active');
        }

    </script>

    <script>
        let currentData = [];
        let currentFilter = "all";
        window.userRole = "";
        window.currentDateFilter = "";
        window.unsubscribe = null;

        const today = new Date();
        const datePass = String(today.getDate()).padStart(2, '0') + String(today.getMonth() + 1).padStart(2, '0') + today.getFullYear();
        document.getElementById('passHint').innerText = datePass;

        // AUTO LOGIN CHECK
        (function checkSession() {
            const savedRole = localStorage.getItem('schoolUserRole');
            const savedDate = localStorage.getItem('schoolLoginDate');

            if (savedRole && savedDate === datePass) {
                window.userRole = savedRole;
                initApp();
            }
        })();

        function login() {
            const u = document.getElementById('username').value.toLowerCase();
            const p = document.getElementById('password').value;
            if (p === datePass && (u === 'reg' || u === 'admin')) {
                window.userRole = u;
                localStorage.setItem('schoolUserRole', u);
                localStorage.setItem('schoolLoginDate', datePass);
                initApp();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function logout() {
            localStorage.removeItem('schoolUserRole');
            localStorage.removeItem('schoolLoginDate');
            location.reload();
        }

        function initApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-interface').classList.remove('hidden');

            if (window.userRole === 'admin') {
                document.getElementById('regTools').classList.add('hidden');
                document.getElementById('adminTools').classList.remove('hidden');
                document.getElementById('roleLabel').innerText = "Admin";
                document.getElementById('init-db-btn').style.display = 'none';
            } else {
                document.getElementById('roleLabel').innerText = "QeydiyyatÃ§Ä±";
            }

            if (window.startRealtimeListener) {
                window.startRealtimeListener();
            } else {
                setTimeout(() => window.startRealtimeListener(), 500);
            }
        }

        function renderAppUI() {
            renderSidebar();
            renderStudents();
            updateStats();
        }

        function renderSidebar() {
            const listDiv = document.getElementById('sidebar-list');
            const classes = [...new Set(window.currentData.map(s => s.class))].sort();
            let html = `<div class="nav-item ${currentFilter === 'all' ? 'active' : ''}" onclick="setFilter('all')">
                            <span>BÃ¼tÃ¼n MÉ™ktÉ™b</span>
                            <span class="count-badge">${window.currentData.length}</span>
                        </div>`;
            classes.forEach(cls => {
                const count = window.currentData.filter(s => s.class === cls).length;
                html += `<div class="nav-item ${currentFilter === cls ? 'active' : ''}" onclick="setFilter('${cls}')">
                            <span>${cls}</span>
                            <span class="count-badge">${count}</span>
                        </div>`;
            });
            listDiv.innerHTML = html;
        }

        function setFilter(cls) {
            currentFilter = cls;
            renderAppUI();
        }

        function renderStudents() {
            const container = document.getElementById('studentContainer');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const todayStr = new Date().toISOString().split('T')[0];
            const isToday = window.currentDateFilter === todayStr;

            const filtered = window.currentData.filter(s => (currentFilter === 'all' || s.class === currentFilter) && s.name.toLowerCase().includes(search));
            container.innerHTML = "";

            const disabledClass = (window.userRole === 'admin' || !isToday) ? 'disabled-mode' : '';

            filtered.forEach(s => {
                let statusClass = `status-${s.status}`;
                let timeText = s.time ? `<span style="color:var(--primary)">â° ${s.time}</span>` : '';
                if (s.status === 'absent') timeText = `<span style="color:var(--danger)">QAYIB</span>`;
                if (s.status === 'permission') timeText = `<span style="color:var(--info)">Ä°CAZÆLÄ° (${s.time})</span>`;

                const card = document.createElement('div');
                card.className = `student-card ${statusClass} fade-in`;
                card.innerHTML = `
                    <div class="card-header">
                        <div><span class="s-name" onclick="window.getStudentHistory('${s.id}')">${s.name}</span><span class="s-class">${s.class}</span></div>
                        <div>${timeText}</div>
                    </div>
                    <div class="actions ${disabledClass}">
                        <button class="btn btn-absent" title="QayÄ±b" onclick="window.updateStudentStatus('${s.id}', 'absent')"><i class="fa-solid fa-xmark"></i></button>
                        <button class="btn btn-late" title="Gecikdi" onclick="window.updateStudentStatus('${s.id}', 'late')"><i class="fa-solid fa-person-running"></i></button>
                        <button class="btn btn-permission" title="Ä°cazÉ™li" onclick="window.updateStudentStatus('${s.id}', 'permission')"><i class="fa-solid fa-person-walking-arrow-right"></i></button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updateStats() {
            const total = window.currentData.length;
            const absent = window.currentData.filter(s => s.status === 'absent').length;
            const late = window.currentData.filter(s => s.status === 'late').length;
            const perm = window.currentData.filter(s => s.status === 'permission').length;
            const present = total - absent - perm;

            document.getElementById('statPresent').innerText = present;
            document.getElementById('statAbsent').innerText = absent;
            document.getElementById('statLate').innerText = late;
            document.getElementById('statPermission').innerText = perm;
        }

        function showNotification(name, status, cls) {
            const area = document.getElementById('notification-area');
            const toast = document.createElement('div');
            let icon = ''; let title = ''; let borderColor = status;

            if (status === 'late') { icon = '<i class="fa-solid fa-person-running" style="color:var(--warning)"></i>'; title = 'Gecikdi'; }
            else if (status === 'absent') { icon = '<i class="fa-solid fa-circle-xmark" style="color:var(--danger)"></i>'; title = 'QayÄ±b'; }
            else if (status === 'permission') { icon = '<i class="fa-solid fa-person-walking-arrow-right" style="color:var(--info)"></i>'; title = 'Ä°cazÉ™ AldÄ±'; }

            let msg = `${name} (${cls}) statusu dÉ™yiÅŸdi.`;
            toast.className = `toast ${borderColor}`;
            toast.innerHTML = `<div class="toast-icon">${icon}</div><div class="toast-content"><h4>${title}</h4><p>${msg}</p></div>`;
            area.appendChild(toast);
            setTimeout(() => { toast.style.animation = 'slideOut 0.5s forwards'; setTimeout(() => toast.remove(), 500); }, 5000);
        }
    </script>
</body>

</html>