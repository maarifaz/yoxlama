<!DOCTYPE html>
<html lang="az">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SchoolFlow - Mobile Final</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --bg-body: #f3f4f6;
            --bg-white: #ffffff;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --info: #3b82f6;
            --sidebar-width: 260px;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-body);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Login Screen */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }

        .login-input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        /* App Layout */
        .app-container {
            display: flex;
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        /* SIDEBAR (Desktop) */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-white);
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        /* MOBILE SIDEBAR */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100%;
                transform: translateX(-100%);
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .overlay-bg {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 900;
                display: none;
            }

            .overlay-bg.active {
                display: block;
            }
        }

        .nav-item {
            padding: 12px 15px;
            margin-bottom: 5px;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            transition: 0.2s;
            color: #333;
        }

        .nav-item:hover {
            background: #f3f4f6;
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .count-badge {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        /* MAIN CONTENT */
        .main {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
            width: 100%;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Hamburger Menu Button */
        .menu-btn {
            display: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--primary);
            background: none;
            border: none;
            padding: 5px;
        }

        @media (max-width: 768px) {
            .menu-btn {
                display: block;
            }
        }

        /* Search Box */
        .search-box {
            background: var(--bg-white);
            padding: 10px 15px;
            border-radius: 50px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid #eee;
            width: 300px;
        }

        .search-box input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 1rem;
        }

        @media (max-width: 768px) {
            .search-box {
                width: 100%;
                order: 3;
            }

            .top-bar {
                justify-content: space-between;
            }
        }

        /* STATS GRID (Responsive) */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-white);
            padding: 15px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .icon-blue {
            background: #e0e7ff;
            color: var(--primary);
        }

        .icon-red {
            background: #fee2e2;
            color: var(--danger);
        }

        .icon-yellow {
            background: #fef3c7;
            color: var(--warning);
        }

        .icon-sky {
            background: #dbeafe;
            color: var(--info);
        }

        .icon-green {
            background: #dcfce7;
            color: var(--success);
        }

        .stat-info h3 {
            margin: 0;
            font-size: 1.4rem;
        }

        .stat-info p {
            margin: 0;
            color: #666;
            font-size: 0.8rem;
        }

        /* STUDENT GRID (Responsive) */
        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            padding-bottom: 80px;
        }

        .student-card {
            background: var(--bg-white);
            border-radius: var(--radius);
            padding: 15px;
            box-shadow: var(--shadow);
            border-top: 5px solid transparent;
            position: relative;
        }

        .status-present {
            border-top-color: #e5e7eb;
        }

        .status-absent {
            border-top-color: var(--danger);
            background: #fff5f5;
        }

        .status-late {
            border-top-color: var(--warning);
            background: #fffbeb;
        }

        .status-permission {
            border-top-color: var(--info);
            background: #eff6ff;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            align-items: flex-start;
        }

        .s-name {
            font-weight: 700;
            display: block;
            font-size: 1rem;
            color: #1f2937;
            cursor: pointer;
            text-decoration: underline;
            text-decoration-color: transparent;
            transition: 0.3s;
        }

        .s-name:hover {
            color: var(--primary);
            text-decoration-color: var(--primary);
        }

        .s-class {
            font-size: 0.75rem;
            background: #f3f4f6;
            padding: 3px 8px;
            border-radius: 6px;
            color: #666;
            display: inline-block;
            margin-top: 4px;
        }

        .actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        /* Action Buttons */
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            transition: 0.2s;
            font-size: 1.1rem;
        }

        .btn-absent {
            background: #ffe4e6;
            color: var(--danger);
        }

        .btn-late {
            background: #fef3c7;
            color: #d97706;
        }

        .btn-permission {
            background: #dbeafe;
            color: #1e40af;
        }

        .disabled-mode {
            pointer-events: none;
            opacity: 0.6;
            filter: grayscale(100%);
        }

        /* Date Picker */
        .date-input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            width: 100%;
            max-width: 200px;
            font-size: 1rem;
        }

        /* Notification & Modal */
        #notification-area {
            position: fixed;
            bottom: 20px;
            right: 20px;
            left: 20px;
            z-index: 1100;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border-left: 5px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideUp 0.3s forwards;
            pointer-events: all;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }

        .toast.late {
            border-left-color: var(--warning);
        }

        .toast.absent {
            border-left-color: var(--danger);
        }

        .toast.permission {
            border-left-color: var(--info);
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
            backdrop-filter: blur(3px);
            padding: 20px;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal {
            background: white;
            width: 100%;
            max-width: 350px;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: 0.3s;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .close-modal {
            cursor: pointer;
            font-size: 1.5rem;
            color: #999;
        }

        .modal-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .modal-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 1rem;
            cursor: pointer;
        }

        /* Init DB Button */
        #init-db-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1f2937;
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            cursor: pointer;
            border: none;
            z-index: 9000;
            opacity: 0.9;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        #init-db-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>

<body>

    <div class="overlay-bg" onclick="toggleSidebar()"></div>

    <div class="modal-overlay" id="customModal">
        <div class="modal">
            <div class="modal-header">
                <span id="modalTitle">Bildiriş</span>
                <span class="close-modal" onclick="closeModal()">×</span>
            </div>
            <div id="modalContent">...</div>
            <button class="modal-btn" onclick="closeModal()">Bağla</button>
        </div>
    </div>

    <div id="notification-area"></div>

    <button id="init-db-btn" onclick="seedDatabase()">
        <i class="fa-solid fa-database"></i> Bazanı Doldur
    </button>

    <div id="login-screen">
        <div class="login-box fade-in">
            <h2 style="color:var(--primary); margin-bottom:5px;">Məktəb Giriş</h2>
            <p style="color:#aaa; font-size:0.9rem; margin-bottom:20px;">Parol: <span id="passHint"></span></p>
            <input type="text" id="username" class="login-input" placeholder="User: reg / admin">
            <input type="password" id="password" class="login-input" placeholder="Parol">
            <button class="login-btn" onclick="login()">Daxil ol</button>
            <p id="loginError" style="color:red; display:none; margin-top:10px;">Parol yanlışdır!</p>
        </div>
    </div>

    <div id="app-interface" class="app-container hidden">

        <div class="sidebar" id="sidebar">
            <h2 style="color:var(--primary); margin-bottom:30px; display:flex; align-items:center; gap:10px;">
                <i class="fa-solid fa-graduation-cap"></i> <span id="roleLabel">Panel</span>
            </h2>
            <div id="sidebar-list"></div>
            <div style="margin-top:auto; padding-top:20px; border-top:1px solid #eee;">
                <div class="nav-item" onclick="logout()">
                    <span><i class="fa-solid fa-right-from-bracket" style="color:var(--danger)"></i> Çıxış</span>
                </div>
            </div>
        </div>

        <div class="main fade-in">
            <div class="top-bar">
                <div style="display:flex; align-items:center; gap:15px;">
                    <button class="menu-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
                    <h2 id="pageTitle" style="margin:0; font-size:1.5rem;">İcmal</h2>
                </div>

                <div id="adminTools" class="hidden">
                    <input type="date" id="historyDate" class="date-input" onchange="changeDate()">
                </div>

                <div class="search-box" id="regTools">
                    <i class="fa-solid fa-magnifying-glass" style="color:#ccc"></i>
                    <input type="text" id="searchInput" placeholder="Axtar..." onkeyup="renderStudents()">
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon icon-green"><i class="fa-solid fa-school"></i></div>
                    <div class="stat-info">
                        <h3 id="statPresent">0</h3>
                        <p>Məktəbdə</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon icon-red"><i class="fa-solid fa-user-xmark"></i></div>
                    <div class="stat-info">
                        <h3 id="statAbsent">0</h3>
                        <p>Qayıb</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon icon-yellow"><i class="fa-solid fa-clock"></i></div>
                    <div class="stat-info">
                        <h3 id="statLate">0</h3>
                        <p>Gecikən</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon icon-sky"><i class="fa-solid fa-person-walking-arrow-right"></i></div>
                    <div class="stat-info">
                        <h3 id="statPermission">0</h3>
                        <p>İcazəli</p>
                    </div>
                </div>
                <div id="statTotal" style="display:none;">0</div>
            </div>

            <div class="student-grid" id="studentContainer">
                <p style="text-align:center; width:100%; color:#888; margin-top:20px;">Məlumatlar yüklənir...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, onSnapshot, writeBatch, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBQkvbGZO_CQ3DJ9IhJpcKN_wG7Emy2A28",
            authDomain: "yoxlama-50bf0.firebaseapp.com",
            projectId: "yoxlama-50bf0",
            storageBucket: "yoxlama-50bf0.firebasestorage.app",
            messagingSenderId: "853010034246",
            appId: "1:853010034246:web:e0337b03ec7b137cb3e447",
            measurementId: "G-0HQNHTJC9T"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global functions
        window.db = db;
        window.seedDatabase = seedDatabase;
        window.updateStudentStatus = updateStudentStatus;
        window.getStudentHistory = getStudentHistory;

        // --- 1. SEED DATABASE (310 NƏFƏR) ---
        async function seedDatabase() {
            const allStudents = [
                { id: '1', name: 'Hacızadə Hafiz Raul', class: '3A' },
                { id: '2', name: 'Mərdəliyev Camal Emil', class: '3A' },
                { id: '3', name: 'Əliyev Atilla Elçin', class: '3A' },
                { id: '4', name: 'Cavadova Xanım Rüfət', class: '3A' },
                { id: '5', name: 'Əlisoy Banu Anar', class: '3A' },
                { id: '6', name: 'Hüseynova Əminə Samir', class: '3A' },
                { id: '7', name: 'Mişeli Ali Efe Remzi', class: '3A' },
                { id: '8', name: 'Səfərli Zeynəb Şövqi', class: '3A' },
                { id: '9', name: 'Xəlil Dəfnə Firdovsi', class: '3A' },
                { id: '10', name: 'Karaşahin Emir Yiğit Ramazan', class: '3A' },
                { id: '11', name: 'İslamov Ariz Orxan', class: '3A' },
                { id: '12', name: 'Məhərrəmli Mehri İlqar', class: '3A' },
                { id: '13', name: 'Zakirova Məryəm Mətləb', class: '3A' },
                { id: '14', name: 'Nəisibli Səma Elşən', class: 'Pre-School (Nigina)' },
                { id: '15', name: 'Süleymanlı Ömər Cabir', class: 'Pre-School (Nigina)' },
                { id: '16', name: 'Hüseyn Abdullah Nazim', class: 'Pre-School (Nigina)' },
                { id: '17', name: 'Ələkbərova Mehri Elşad', class: 'Pre-School (Nigina)' },
                { id: '18', name: 'Həsənli Yunus İmdad', class: 'Pre-School (Nigina)' },
                { id: '19', name: 'Mehdiyev Gəray Aydın', class: 'Pre-School (Nigina)' },
                { id: '20', name: 'Hüseynli Humay Araz', class: 'Pre-School (Nigina)' },
                { id: '21', name: 'Xəlilli Cansu Vüqar', class: 'Pre-School (Nigina)' },
                { id: '22', name: 'Əhmədli Turqut Fazil', class: 'Pre-School (Nigina)' },
                { id: '23', name: 'Səfərli Fərəh Elnur', class: 'Pre-School (Nigina)' },
                { id: '24', name: 'Bəylərova Ayan Mahir qızı', class: 'Pre-School (Nigina)' },
                { id: '25', name: 'Vəlizadə Doğan Aqil', class: '2B' },
                { id: '26', name: 'Kərimova Nərgiz Cavid', class: '2B' },
                { id: '27', name: 'Kərimov Əziz Cavid', class: '2B' },
                { id: '28', name: 'Vəliyev Raul Ramin', class: '2B' },
                { id: '29', name: 'Rəsulova Nilay Fuad', class: '2B' },
                { id: '30', name: 'Əliyeva Mədinə Vahid', class: '2B' },
                { id: '31', name: 'Piriyeva Aylin Zaur', class: '2B' },
                { id: '32', name: 'Əkbər Aliyə Elçin', class: '2B' },
                { id: '33', name: 'Hacıyeva Mədinə Samir', class: '2B' },
                { id: '34', name: 'Süleymanova Melissa Ruslan', class: '2B' },
                { id: '35', name: 'Qasımov Davud Rafiq', class: '2B' },
                { id: '36', name: 'Nəisibli Saleh Elşən', class: '2B' },
                { id: '37', name: 'İsalı Hüseyn Elnur', class: '2B' },
                { id: '38', name: 'Kamilli Badisəba Cəmil', class: '2B' },
                { id: '39', name: 'Ağayeva Elyanora Elnur', class: '2B' },
                { id: '40', name: 'Əsədova Humay Ruslan', class: '2B' },
                { id: '41', name: 'Fətiyev Ceylan Vüqar', class: '2B' },
                { id: '42', name: 'Safiya Əhmədzadə Camal', class: 'Pre-School (Aysu)' },
                { id: '43', name: 'Kazımova Sofiya Əhəd', class: 'Pre-School (Aysu)' },
                { id: '44', name: 'Namazov Cavidan Anar', class: 'Pre-School (Aysu)' },
                { id: '45', name: 'Məhərrəmli Altay İlqar', class: 'Pre-School (Aysu)' },
                { id: '46', name: 'Quliyeva Şəms Orxan', class: 'Pre-School (Aysu)' },
                { id: '47', name: 'Əliyeva Gülxəndə Ziya', class: 'Pre-School (Aysu)' },
                { id: '48', name: 'Əhmədli Selin Tural', class: 'Pre-School (Aysu)' },
                { id: '49', name: 'Miriyev Mircabbar Rüfət', class: 'Pre-School (Aysu)' },
                { id: '50', name: 'Əmirli Əsmər Saxavəddin qızı', class: 'Pre-School (Aysu)' },
                { id: '51', name: 'Sultanlı Mirsahib Mirdavud oğlu', class: 'Pre-School (Aysu)' },
                { id: '52', name: 'Mansirov Cəlal Nizami', class: '4A' },
                { id: '53', name: 'Məmmədov Hüseyn Anar', class: '4A' },
                { id: '54', name: 'Eyvazov Cavad Xəyyam', class: '4A' },
                { id: '55', name: 'İbrahimli Camal Kamran', class: '4A' },
                { id: '56', name: 'Mustafa Ayşənur Rəhim', class: '4A' },
                { id: '57', name: 'Əliyev Tamerlan Hikmət', class: '4A' },
                { id: '58', name: 'Heydərov Məhəmməd Süleyman', class: '4A' },
                { id: '59', name: 'Məmmədli Banu Emil', class: '4A' },
                { id: '60', name: 'Hümmətova Əsmər Emil', class: '4A' },
                { id: '61', name: 'Hümmətov Ayaz Emil', class: '4A' },
                { id: '62', name: 'Səmədli Miray Alim', class: '4A' },
                { id: '63', name: 'Qasımlı Dəniz Soltan', class: '4A' },
                { id: '64', name: 'Cavadova Sara Rüfət', class: '4A' },
                { id: '65', name: 'Mərdanlı Mələk Əli', class: '4A' },
                { id: '66', name: 'Hüseynli Kamil Əhməd', class: '4A' },
                { id: '67', name: 'Adıgözəlova Nilufər Orxan', class: '4A' },
                { id: '68', name: 'Əsgər Aişə Mətləb', class: '4A' },
                { id: '69', name: 'Şükürlü Dilək Anar', class: '4A' },
                { id: '70', name: 'Həmidsoy İnci Səbuhi', class: '4A' },
                { id: '71', name: 'Ömrümova Arzu Nicat', class: '4A' },
                { id: '72', name: 'Fərhadov Fuad Mirzə', class: '2A' },
                { id: '73', name: 'Həsənli İnci Azad', class: '2A' },
                { id: '74', name: 'Babaoğlu Muhammed Kerem', class: '2A' },
                { id: '75', name: 'Abaslı Məryəm Orxan', class: '2A' },
                { id: '76', name: 'Göyüşlü Mələk Azər', class: '2A' },
                { id: '77', name: 'Ağayeva Zeynəb Elşən', class: '2A' },
                { id: '78', name: 'Ağayeva Məryəm Elşən', class: '2A' },
                { id: '79', name: 'İbrahimli Cahan Kamran', class: '2A' },
                { id: '80', name: 'Rzayeva Fatimə Tural', class: '2A' },
                { id: '81', name: 'Babaev İlkin Niyaməddin', class: '2A' },
                { id: '82', name: 'Məmmədli Cavad Nicat', class: '2A' },
                { id: '83', name: 'Mustafazadə Mirteymur Mircavad', class: '2A' },
                { id: '84', name: 'Gözəlov Alparslan Tural', class: '2A' },
                { id: '85', name: 'Hümbətzadə Sofiya Rauf', class: '2A' },
                { id: '86', name: 'Roman Qurbanov Teymur', class: '2A' },
                { id: '87', name: 'Əlizadə Ceyhan Füzuli', class: '2A' },
                { id: '88', name: 'Zakirov Mərdan Mətləb', class: '2A' },
                { id: '89', name: 'Kanberoğlu Melis Önder', class: '2A' },
                { id: '90', name: 'Həsənli Səlim Orxan', class: '2A' },
                { id: '91', name: 'Ələkbərova Sevil Elşad', class: '1A' },
                { id: '92', name: 'Ələkbərli Altun Kamran', class: '1A' },
                { id: '93', name: 'İbrahimli Mirel Faiq', class: '1A' },
                { id: '94', name: 'Piriyev David Zaur', class: '1A' },
                { id: '95', name: 'İbrahimli Suad Sərxan', class: '1A' },
                { id: '96', name: 'Əhməd İbrahim Əli', class: '1A' },
                { id: '97', name: 'Eminli Səmra Elşad', class: '1A' },
                { id: '98', name: 'İbrahimova Leyla Elşad', class: '1A' },
                { id: '99', name: 'Abbas Nərgiz Elçin', class: '1A' },
                { id: '100', name: 'Əlisoy Sara Ramal', class: '1A' },
                { id: '101', name: 'Eyvazlı Turqut Təmkin', class: '1A' },
                { id: '102', name: 'Əmirli İradə Saxavəddin', class: '1A' },
                { id: '103', name: 'Vəliyeva Aylin Elşad', class: '1A' },
                { id: '104', name: 'Rəfizadə Humay İbrahim', class: '1A' },
                { id: '105', name: 'Qasımlı Hiranur Vəli', class: '1A' },
                { id: '106', name: 'Əzimov Maqsud Nicat', class: '1A' },
                { id: '107', name: 'Cəfər Şövqi Azər', class: '1A' },
                { id: '108', name: 'Həmidsoy Sevil Səbuhi', class: '1A' },
                { id: '109', name: 'Abbaszadə Məryəm Murad', class: '1A' },
                { id: '110', name: 'Əhmədli İbrahim Fazil', class: '1A' },
                { id: '111', name: 'Abdullah İrfan Ziya', class: '3B' },
                { id: '112', name: 'Mərdəliyeva Aylin Emil', class: '3B' },
                { id: '113', name: 'Yener Amine Sercan', class: '3B' },
                { id: '114', name: 'Quliyeva Melis Əziz', class: '3B' },
                { id: '115', name: 'Tağızadə Mələk Elzamin', class: '3B' },
                { id: '116', name: 'Yıldırım Ertuğrul Zülküf', class: '3B' },
                { id: '117', name: 'Ravza Altıntop', class: '3B' },
                { id: '118', name: 'Məmmədova Nigar Müşfiq', class: '3B' },
                { id: '119', name: 'Heydərli Heydər Savalan', class: '3B' },
                { id: '120', name: 'Adıgözəlov Məhəmmədəli Rövşən', class: '3B' },
                { id: '121', name: 'Abbaslı İnci Abbas', class: '3B' },
                { id: '122', name: 'Musalı Fərəh Pərviz qızı', class: '3B' },
                { id: '123', name: 'Aliyev Maisa', class: '3B' },
                { id: '124', name: 'Ağazadə Uğur Elnur', class: 'Pre-School (Aydan)' },
                { id: '125', name: 'Əliyeva Ayət Hikmət', class: 'Pre-School (Aydan)' },
                { id: '126', name: 'Əbləsənova Cahan Rəşad', class: 'Pre-School (Aydan)' },
                { id: '127', name: 'İslamzadə Turqut Namiq', class: 'Pre-School (Aydan)' },
                { id: '128', name: 'Zülfüqarlı Sevinc Asim', class: 'Pre-School (Aydan)' },
                { id: '129', name: 'Ağabəyzadə Faiq Rəcəb', class: 'Pre-School (Aydan)' },
                { id: '130', name: 'İbadzadə Miryusif Elmir', class: 'Pre-School (Aydan)' },
                { id: '131', name: 'Məhərrəmzadə Araz Anar', class: 'Pre-School (Aydan)' },
                { id: '132', name: 'Əsgərli Tuana Nicat', class: 'Pre-School (Aydan)' },
                { id: '133', name: 'İmanlı Melisa Ruhəli', class: 'Pre-School (Aydan)' },
                { id: '134', name: 'Hüseynzadə Sara Cahangir', class: 'Pre-School (Aydan)' },
                { id: '135', name: 'Həsənli Ayla Azad', class: '1B' },
                { id: '136', name: 'Bağırzadə Selcan Elşən', class: '1B' },
                { id: '137', name: 'Məmmədli Turan Emil', class: '1B' },
                { id: '138', name: 'Paşayev Yusif Zaur', class: '1B' },
                { id: '139', name: 'İbrahimova Sara Elşad', class: '1B' },
                { id: '140', name: 'Aşurov Mahir Sənan', class: '1B' },
                { id: '141', name: 'Bəylər Fərhad Anar', class: '1B' },
                { id: '142', name: 'Ağalı Mira Xeyrəddin', class: '1B' },
                { id: '143', name: 'Gözəlova Sunay Tural', class: '1B' },
                { id: '144', name: 'Hacıyev İlqar Aqil', class: '1B' },
                { id: '145', name: 'Kazımova Tahirə Əhəd', class: '1B' },
                { id: '146', name: 'Rüstəm Nur Ülvi', class: '1B' },
                { id: '147', name: 'Allahverdiyeva Milana Fərid', class: '1B' },
                { id: '148', name: 'Adıgözəlov Elmar Orxan', class: '1B' },
                { id: '149', name: 'Sadmaliyeva Ayza Zahid', class: '1B' },
                { id: '150', name: 'Çağlayan Asya Lina', class: '1B' },
                { id: '151', name: 'Hüseynzadə Jasmin Cahangir', class: '1B' },
                { id: '152', name: 'Abbaslı Ələkbər Abbas', class: '1B' },
                { id: '153', name: 'Qulizadə Fikrət Samir', class: '1B' },
                { id: '154', name: 'Tağızadə Fatimə Elzamin', class: '6B' },
                { id: '155', name: 'Gözəlova Aidə Tural', class: '6B' },
                { id: '156', name: 'Fərzəliyev Fərid Samir', class: '6B' },
                { id: '157', name: 'Ömrümov Murat Nicat', class: '6B' },
                { id: '158', name: 'Rəsulova Aida Vüqar', class: '6B' },
                { id: '159', name: 'Nəisibli Məsim Rüstəm', class: '6B' },
                { id: '160', name: 'Hüseynli Məryəm Araz', class: '6B' },
                { id: '161', name: 'Abaslı Məhəmməd Xalid', class: '6B' },
                { id: '162', name: 'Həsənov Ömər Orxan', class: '6B' },
                { id: '163', name: 'Əkbərli Fidan Nəriman', class: '6B' },
                { id: '164', name: 'Nadirova Mədinə Rəşad', class: '6B' },
                { id: '165', name: 'Gülverdiyeva Dəniz Qoşqar', class: '6B' },
                { id: '166', name: 'Şahbazzadə Banu Ziya', class: '6B' },
                { id: '167', name: 'Piriyev Abdullah Sunay oğlu', class: '6B' },
                { id: '168', name: 'Aliyev Abbas Kaan', class: '6B' },
                { id: '169', name: 'Əliyeva Aydan Zamiq qızı', class: '6B' },
                { id: '170', name: 'Abdulhamit Kara', class: '6B' },
                { id: '171', name: 'Sultanəhmədov Rafiq Ramin', class: '7B' },
                { id: '172', name: 'Bağırov Əliyar Emin', class: '7B' },
                { id: '173', name: 'Məmmədli Hüseyn Vüqar', class: '7B' },
                { id: '174', name: 'Oğuzxan Qurbanov Teymur', class: '7B' },
                { id: '175', name: 'Muradzadə Kənan Rövşən', class: '7B' },
                { id: '176', name: 'Muradzadə Nadir Rövşən', class: '7B' },
                { id: '177', name: 'Şahmarova Milana İsrafil', class: '7B' },
                { id: '178', name: 'Məmmədli Davud Rövşən', class: '7B' },
                { id: '179', name: 'Musalı Fateh Pərviz oğlu', class: '7B' },
                { id: '180', name: 'İbrahimov Məmmədağa Veysəl oğlu', class: '7B' },
                { id: '181', name: 'Səfərəliyeva Zərif İntiqam qızı', class: '7B' },
                { id: '182', name: 'Məmmədli Dəniz Vüsal', class: '7B' },
                { id: '183', name: 'Hüseynli Fatimə Araz', class: '8' },
                { id: '184', name: 'Kərimli Nuran Ramil', class: '8' },
                { id: '185', name: 'Zülfüqarlı Resul Elçin', class: '8' },
                { id: '186', name: 'Əhmədov Ömər Rahim', class: '8' },
                { id: '187', name: 'Eminova Cəvahir Nəzər', class: '8' },
                { id: '188', name: 'Hüseynov Ağarza Samir', class: '8' },
                { id: '189', name: 'Müslüm Məhəmməd Emin Yusif', class: '8' },
                { id: '190', name: 'Hüseynli Nihat Emin', class: '8' },
                { id: '191', name: 'Fərzəliyev Camal Samir', class: '8' },
                { id: '192', name: 'Ağakişiyev Hüseyn Ələkbər', class: '8' },
                { id: '193', name: 'Muradzadə Nuran Nurlan', class: '8' },
                { id: '194', name: 'İslamzadə Əli Namiq', class: '8' },
                { id: '195', name: 'Məsimli İsmayıl Coşqun', class: '8' },
                { id: '196', name: 'Əliyev Novruz Nicat', class: '8' },
                { id: '197', name: 'Əsədov Nail Ruslan', class: '8' },
                { id: '198', name: 'Əsgərova Türkan Nail', class: '8' },
                { id: '199', name: 'İskəndərli Sevil Anar', class: '8' },
                { id: '200', name: 'İmanlı Gülzar Ülvi qızı', class: '8' },
                { id: '201', name: 'Əliyev Ramal Zamiq oğlu', class: '8' },
                { id: '202', name: 'Məlikov İmran Elçin', class: '7A' },
                { id: '203', name: 'Abdullah Ramiz Ziya', class: '7A' },
                { id: '204', name: 'Abbasov Attila Zəka', class: '7A' },
                { id: '205', name: 'Müslüm Əli Yusif', class: '7A' },
                { id: '206', name: 'Əsgərzadə Səməd Yalçın', class: '7A' },
                { id: '207', name: 'İsalı Zeynəb Elnur', class: '7A' },
                { id: '208', name: 'Bayramov Məhəmmədcavad Cavid', class: '7A' },
                { id: '209', name: 'Həsən Amir Vaqif', class: '7A' },
                { id: '210', name: 'Emir Kağan Altıntop', class: '7A' },
                { id: '211', name: 'Qüdrətzadə Zərif Elnur', class: '7A' },
                { id: '212', name: 'Rəsulov İslam Vüqar', class: '7A' },
                { id: '213', name: 'Muradzadə Nazlı Nurlan', class: '7A' },
                { id: '214', name: 'Qəhrəmanbəyli Fərman Samir', class: '9' },
                { id: '215', name: 'Cahangirov Fərid Asif', class: '9' },
                { id: '216', name: 'Süleymanova İnci Ruslan', class: '9' },
                { id: '217', name: 'Qasımlı Nailə Soltan', class: '9' },
                { id: '218', name: 'Bayramova Yasəmən Cavid', class: '9' },
                { id: '219', name: 'Yılmaz Yasin Cuma', class: '9' },
                { id: '220', name: 'Qaraşzadə Cəlal İbrahim', class: '9' },
                { id: '221', name: 'Qafur Qüdrətzadə Elnur', class: '9' },
                { id: '222', name: 'Zülfüqarlı Zülfiyyə Asim', class: '9' },
                { id: '223', name: 'Səfərova Ayan Rafael', class: '9' },
                { id: '224', name: 'Rüstəmzadə Gülsüm', class: '9' },
                { id: '225', name: 'Əsədov Rəsul Ruslan', class: '9' },
                { id: '226', name: 'Bağırova Jasmin Fərid', class: '9' },
                { id: '227', name: 'Mikailli Ömər Ruslan oğlu', class: '9' },
                { id: '228', name: 'Səfərəliyeva Humay İntiqam', class: '9' },
                { id: '229', name: 'Sultanlı Leyla Mirdavud qızı', class: '9' },
                { id: '230', name: 'Özdemir Ahmet Selim Uğur', class: '9' },
                { id: '231', name: 'Eraslan Öykü Cafer', class: '9' },
                { id: '232', name: 'Ahmet Kayra Gülbay', class: '9' },
                { id: '233', name: 'Gümüş Tusem Muhammet', class: '9' },
                { id: '234', name: 'Hüseynli Zeynəb Araz', class: '6A' },
                { id: '235', name: 'Cahangirova Leyla Asif', class: '6A' },
                { id: '236', name: 'Məmmədli Ömər Emil', class: '6A' },
                { id: '237', name: 'İsmayılzadə Davud Rəhman', class: '6A' },
                { id: '238', name: 'Məmmədov Talib Xəqani', class: '6A' },
                { id: '239', name: 'Abdullazadə Yusif Ruslan', class: '6A' },
                { id: '240', name: 'Selin Esra Koç Nuh', class: '6A' },
                { id: '241', name: 'Babakişiyeva Ayişə Bəhman', class: '6A' },
                { id: '242', name: 'Vəlizadə Nilay Anar', class: '6A' },
                { id: '243', name: 'Abbas Safiyə Elçin', class: '6A' },
                { id: '244', name: 'Yener Ahmet Bilal Sercan', class: '6A' },
                { id: '245', name: 'Allahverdi Yusif Ramil', class: '6A' },
                { id: '246', name: 'Xəlil Dəniz Firdovsi', class: '6A' },
                { id: '247', name: 'İsalı Ayla Həsən', class: '6A' },
                { id: '248', name: 'Beyazıt Alkan Samet', class: '6A' },
                { id: '249', name: 'İmanlı Fatimə Ruhəli', class: '6A' },
                { id: '250', name: 'Məmmədli Oğuz Vüsal', class: '6A' },
                { id: '251', name: 'Aydoğmuş Elif Yaren', class: '6A' },
                { id: '252', name: 'Məmmədov Murad Müşfiq', class: '5B' },
                { id: '253', name: 'Gülafzadə Fərəh Fuad', class: '5B' },
                { id: '254', name: 'Alşanlı Aytac Rəşad', class: '5B' },
                { id: '255', name: 'Sadullayeva Amira Elxan', class: '5B' },
                { id: '256', name: 'Şahmarova Sofiya İsrafil', class: '5B' },
                { id: '257', name: 'Çıraqzadə Esmanur Nazir', class: '5B' },
                { id: '258', name: 'Nəisibli Fərhad Tural', class: '5B' },
                { id: '259', name: 'Demir Hülya Miray İbrahim', class: '5B' },
                { id: '260', name: 'Əliyev Raul Rəşid', class: '5B' },
                { id: '261', name: 'Fleq Fəhrin Yusif', class: '5B' },
                { id: '262', name: 'Şəfizadə İsmayıl Elvin', class: '5B' },
                { id: '263', name: 'Kazımlı Altay Araz', class: '5B' },
                { id: '264', name: 'Rəfiyev İsmayıl Polad', class: '5B' },
                { id: '265', name: 'Hüseynli Fidan Araz', class: '5B' },
                { id: '266', name: 'Yaqublu Yusif Oqtay', class: '5B' },
                { id: '267', name: 'Əliyev Ömər Nicat', class: '5B' },
                { id: '268', name: 'Əbdüləzim Oğuz İsmayıl', class: '5B' },
                { id: '269', name: 'Əbdüləzim Əminə İsmayıl', class: '5B' },
                { id: '270', name: 'Bağırov Mircamal Fərid', class: '5B' },
                { id: '271', name: 'Heydərov Ziya Əzim oğlu', class: '5B' },
                { id: '272', name: 'Mikailli Nazlı Ruslan qızı', class: '5B' },
                { id: '273', name: 'Feyzullayeva Cansu Etibar', class: '5A' },
                { id: '274', name: 'İbrahimli Leyla Faiq', class: '5A' },
                { id: '275', name: 'Cahangirov Amir Asif', class: '5A' },
                { id: '276', name: 'Kərimli İbrahim Ramil', class: '5A' },
                { id: '277', name: 'Yüzbaşova Leyli Rüfət', class: '5A' },
                { id: '278', name: 'Süleymanlı Yusuf Cabir', class: '5A' },
                { id: '279', name: 'Məmmədli Murad Nicat', class: '5A' },
                { id: '280', name: 'Əlizadə Ayxan Anar', class: '5A' },
                { id: '281', name: 'Hüseynzadə Səməd Murad', class: '5A' },
                { id: '282', name: 'Namazova Fidan Anar', class: '5A' },
                { id: '283', name: 'Qasımova İnci Tale', class: '5A' },
                { id: '284', name: 'Həsən Asəf Vaqif', class: '5A' },
                { id: '285', name: 'Qaraşov Kamal İbrahim', class: '5A' },
                { id: '286', name: 'Zəfər Qüdrətzadə Elnur', class: '5A' },
                { id: '287', name: 'Rüstəmzadə Fərid Elşən', class: '5A' },
                { id: '288', name: 'Əlizadə Lalə Pərviz', class: '5A' },
                { id: '289', name: 'Xanməmmədov Əsmər Rəşad', class: '5A' },
                { id: '290', name: 'Xanməmmədov Murad Rəşad', class: '5A' },
                { id: '291', name: 'İsgəndərli Zeynəb Sərxan', class: '5A' },
                { id: '292', name: 'Sərxanlı Sərxan Xəqani', class: '5A' },
                { id: '293', name: 'Özdemir Sena Uğur qızı', class: '5A' },
                { id: '294', name: 'Adıgözəlov Cavad Orxan', class: '4B' },
                { id: '295', name: 'Alina Əbülhəsənli Türkel', class: '4B' },
                { id: '296', name: 'Mərdan Oğuzxan Orxan', class: '4B' },
                { id: '297', name: 'Çıraqzadə Ərtuğrul Nazir', class: '4B' },
                { id: '298', name: 'Demir Aras İbrahim', class: '4B' },
                { id: '299', name: 'Əsgər Osman Sənan', class: '4B' },
                { id: '300', name: 'Abaslı İmran Xalid', class: '4B' },
                { id: '301', name: 'Əsgərsoy Nazlı İsmayıl', class: '4B' },
                { id: '302', name: 'Əhmədli Mikayıl Tural', class: '4B' },
                { id: '303', name: 'Əsgərov Yasin Nail', class: '4B' },
                { id: '304', name: 'Ələkbərli Turxan Toğrul', class: '4B' },
                { id: '305', name: 'Gülverdiyev Ayxan Qoşqar', class: '4B' },
                { id: '306', name: 'Baxşəlizadə Atilla Xəzri', class: '4B' },
                { id: '307', name: 'Əkbərzadə Səlim Rəşad oğlu', class: '4B' },
                { id: '308', name: 'Səfərəliyev Bəhman İntiqam oğlu', class: '4B' },
                { id: '309', name: 'Sultanlı Banu Mirdavud qızı', class: '4B' },
                { id: '310', name: 'Məmmədov Səid Pərviz oğlu', class: '4B' }
            ];

            if (!confirm("Diqqət! Bütün məlumatlar silinib " + allStudents.length + " şagird yazılacaq. Razısan?")) return;

            const batch = writeBatch(db);

            allStudents.forEach(student => {
                const docRef = doc(db, "students", student.id);
                // Default status: present
                batch.set(docRef, { ...student, status: 'present', time: '', lastUpdated: new Date().toISOString() });
            });

            await batch.commit();
            customAlert("Baza uğurla dolduruldu! Səhifə yenilənir.");
            setTimeout(() => location.reload(), 1500);
        }

        // --- 2. STATUS YENİLƏMƏK (Log ilə) ---
        async function updateStudentStatus(id, type) {
            if (window.userRole === 'admin') return;

            const todayDate = new Date().toISOString().split('T')[0];
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');

            const currentS = window.currentData.find(s => s.id === id);

            let finalStatus = type;
            let finalTime = (type === 'late' || type === 'permission') ? timeStr : '';

            if (currentS && currentS.status === type) {
                finalStatus = 'present';
                finalTime = '';
            }

            // Update Master
            const studentRef = doc(db, "students", id);
            await updateDoc(studentRef, {
                status: finalStatus,
                time: finalTime
            });

            // Update Log
            const logId = `${todayDate}_${id}`;
            const logRef = doc(db, "attendance", logId);

            await setDoc(logRef, {
                studentId: id,
                name: currentS.name,
                class: currentS.class,
                date: todayDate,
                status: finalStatus,
                time: finalTime
            });
        }

        // --- 3. ŞAGİRD DOSYESİ ---
        async function getStudentHistory(id) {
            const q = query(collection(db, "attendance"), where("studentId", "==", id));
            const querySnapshot = await getDocs(q);

            let late = 0, absent = 0, perm = 0;

            querySnapshot.forEach((doc) => {
                const d = doc.data();
                if (d.status === 'late') late++;
                if (d.status === 'absent') absent++;
                if (d.status === 'permission') perm++;
            });

            const student = window.currentData.find(s => s.id === id);

            const html = `
                <div class="modal-row"><span>Ad Soyad:</span> <strong>${student.name}</strong></div>
                <div class="modal-row"><span>Sinif:</span> <strong>${student.class}</strong></div>
                <hr style="margin:10px 0; border:0; border-top:1px solid #eee;">
                <div class="modal-row"><span>Qayıb:</span> <strong style="color:var(--danger)">${absent}</strong></div>
                <div class="modal-row"><span>Gecikmə:</span> <strong style="color:var(--warning)">${late}</strong></div>
                <div class="modal-row"><span>İcazə:</span> <strong style="color:var(--info)">${perm}</strong></div>
            `;

            customAlert(html, "Şagird Dosyesi");
        }

        // --- 4. REALTIME LISTENER & HISTORY ---
        window.startRealtimeListener = function () {
            const today = new Date().toISOString().split('T')[0];
            if (window.userRole === 'admin') {
                document.getElementById('historyDate').value = today;
            }
            window.currentDateFilter = today;
            loadData();
        }

        window.loadData = function () {
            const today = new Date().toISOString().split('T')[0];
            const selectedDate = window.currentDateFilter;

            if (selectedDate === today) {
                const q = collection(db, "students");
                window.unsubscribe = onSnapshot(q, (snapshot) => {
                    const students = [];
                    snapshot.forEach((doc) => { students.push(doc.data()); });
                    window.currentData = students;
                    renderAppUI();

                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "modified" && window.userRole === 'admin') {
                            const data = change.doc.data();
                            if (data.status !== 'present') showNotification(data.name, data.status, data.class);
                        }
                    });
                });
            } else {
                if (window.unsubscribe) window.unsubscribe();

                getDocs(collection(db, "students")).then(masterSnap => {
                    let tempStudents = [];
                    masterSnap.forEach(doc => {
                        tempStudents.push({ ...doc.data(), status: 'present', time: '' });
                    });

                    const qLog = query(collection(db, "attendance"), where("date", "==", selectedDate));
                    getDocs(qLog).then(logSnap => {
                        logSnap.forEach(doc => {
                            const log = doc.data();
                            const index = tempStudents.findIndex(s => s.id === log.studentId);
                            if (index !== -1) {
                                tempStudents[index].status = log.status;
                                tempStudents[index].time = log.time;
                            }
                        });
                        window.currentData = tempStudents;
                        renderAppUI();
                    });
                });
            }
        }

        window.changeDate = function () {
            window.currentDateFilter = document.getElementById('historyDate').value;
            loadData();
        }

        window.customAlert = function (content, title = "Bildiriş") {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('customModal').classList.add('active');
        }
        window.closeModal = function () {
            document.getElementById('customModal').classList.remove('active');
        }

        window.toggleSidebar = function () {
            document.getElementById('sidebar').classList.toggle('active');
            document.querySelector('.overlay-bg').classList.toggle('active');
        }

    </script>

    <script>
        let currentData = [];
        let currentFilter = "all";
        window.userRole = "";
        window.currentDateFilter = "";
        window.unsubscribe = null;

        const today = new Date();
        const datePass = String(today.getDate()).padStart(2, '0') + String(today.getMonth() + 1).padStart(2, '0') + today.getFullYear();
        document.getElementById('passHint').innerText = datePass;

        // AUTO LOGIN CHECK
        (function checkSession() {
            const savedRole = localStorage.getItem('schoolUserRole');
            const savedDate = localStorage.getItem('schoolLoginDate');

            if (savedRole && savedDate === datePass) {
                window.userRole = savedRole;
                initApp();
            }
        })();

        function login() {
            const u = document.getElementById('username').value.toLowerCase();
            const p = document.getElementById('password').value;
            if (p === datePass && (u === 'reg' || u === 'admin')) {
                window.userRole = u;
                localStorage.setItem('schoolUserRole', u);
                localStorage.setItem('schoolLoginDate', datePass);
                initApp();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function logout() {
            localStorage.removeItem('schoolUserRole');
            localStorage.removeItem('schoolLoginDate');
            location.reload();
        }

        function initApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-interface').classList.remove('hidden');

            if (window.userRole === 'admin') {
                document.getElementById('regTools').classList.add('hidden');
                document.getElementById('adminTools').classList.remove('hidden');
                document.getElementById('roleLabel').innerText = "Admin";
                document.getElementById('init-db-btn').style.display = 'none';
            } else {
                document.getElementById('roleLabel').innerText = "Qeydiyyatçı";
            }

            if (window.startRealtimeListener) {
                window.startRealtimeListener();
            } else {
                setTimeout(() => window.startRealtimeListener(), 500);
            }
        }

        function renderAppUI() {
            renderSidebar();
            renderStudents();
            updateStats();
        }

        function renderSidebar() {
            const listDiv = document.getElementById('sidebar-list');
            const classes = [...new Set(window.currentData.map(s => s.class))].sort();
            let html = `<div class="nav-item ${currentFilter === 'all' ? 'active' : ''}" onclick="setFilter('all')">
                            <span>Bütün Məktəb</span>
                            <span class="count-badge">${window.currentData.length}</span>
                        </div>`;
            classes.forEach(cls => {
                const count = window.currentData.filter(s => s.class === cls).length;
                html += `<div class="nav-item ${currentFilter === cls ? 'active' : ''}" onclick="setFilter('${cls}')">
                            <span>${cls}</span>
                            <span class="count-badge">${count}</span>
                        </div>`;
            });
            listDiv.innerHTML = html;
        }

        function setFilter(cls) {
            currentFilter = cls;
            // Mobilde menyunu bagla
            if (window.innerWidth < 768) toggleSidebar();
            renderAppUI();
        }

        function renderStudents() {
            const container = document.getElementById('studentContainer');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const todayStr = new Date().toISOString().split('T')[0];
            const isToday = window.currentDateFilter === todayStr;

            const filtered = window.currentData.filter(s => (currentFilter === 'all' || s.class === currentFilter) && s.name.toLowerCase().includes(search));
            container.innerHTML = "";

            const disabledClass = (window.userRole === 'admin' || !isToday) ? 'disabled-mode' : '';

            filtered.forEach(s => {
                let statusClass = `status-${s.status}`;
                let timeText = s.time ? `<span style="color:var(--primary)">⏰ ${s.time}</span>` : '';
                if (s.status === 'absent') timeText = `<span style="color:var(--danger)">QAYIB</span>`;
                if (s.status === 'permission') timeText = `<span style="color:var(--info)">İCAZƏLİ (${s.time})</span>`;

                const card = document.createElement('div');
                card.className = `student-card ${statusClass} fade-in`;
                card.innerHTML = `
                    <div class="card-header">
                        <div><span class="s-name" onclick="window.getStudentHistory('${s.id}')">${s.name}</span><span class="s-class">${s.class}</span></div>
                        <div>${timeText}</div>
                    </div>
                    <div class="actions ${disabledClass}">
                        <button class="btn btn-absent" title="Qayıb" onclick="window.updateStudentStatus('${s.id}', 'absent')"><i class="fa-solid fa-xmark"></i></button>
                        <button class="btn btn-late" title="Gecikdi" onclick="window.updateStudentStatus('${s.id}', 'late')"><i class="fa-solid fa-person-running"></i></button>
                        <button class="btn btn-permission" title="İcazəli" onclick="window.updateStudentStatus('${s.id}', 'permission')"><i class="fa-solid fa-person-walking-arrow-right"></i></button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updateStats() {
            const total = window.currentData.length;
            const absent = window.currentData.filter(s => s.status === 'absent').length;
            const late = window.currentData.filter(s => s.status === 'late').length;
            const perm = window.currentData.filter(s => s.status === 'permission').length;
            const present = total - absent - perm;

            document.getElementById('statPresent').innerText = present;
            document.getElementById('statAbsent').innerText = absent;
            document.getElementById('statLate').innerText = late;
            document.getElementById('statPermission').innerText = perm;
        }

        function showNotification(name, status, cls) {
            const area = document.getElementById('notification-area');
            const toast = document.createElement('div');
            let icon = ''; let title = ''; let borderColor = status;

            if (status === 'late') { icon = '<i class="fa-solid fa-person-running" style="color:var(--warning)"></i>'; title = 'Gecikdi'; }
            else if (status === 'absent') { icon = '<i class="fa-solid fa-circle-xmark" style="color:var(--danger)"></i>'; title = 'Qayıb'; }
            else if (status === 'permission') { icon = '<i class="fa-solid fa-person-walking-arrow-right" style="color:var(--info)"></i>'; title = 'İcazə Aldı'; }

            let msg = `${name} (${cls}) statusu dəyişdi.`;
            toast.className = `toast ${borderColor}`;
            toast.innerHTML = `<div class="toast-icon">${icon}</div><div class="toast-content"><h4>${title}</h4><p>${msg}</p></div>`;
            area.appendChild(toast);
            setTimeout(() => { toast.style.animation = 'slideOut 0.5s forwards'; setTimeout(() => toast.remove(), 500); }, 5000);
        }
    </script>
</body>

</html>